---
layout: post
tags: [github, github-action, nomad, nomad-pck]
published: false
---



### 서론
나 노마드 안좋아함.


### 콘술설치 넣어야함1!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

### 다운로드
- https://developer.hashicorp.com/nomad
- 이 문서에서는 노마드의 루트를 C:/nomad/ 로하고
- 노마드를 C:/nomad/nomad.exe 에 복사했다는 가정하에 진행되니 경로는 본인에 맞게 고치시기 바랍니다.
- 하는김에 nomad 를 환경변수에 등록하자.

### 실행 (주의)
- 아래처럼 nomad.hcl 파일을 만들어주자.
```
# 데이터 센터 이름 / 경로
datacenter = "dc1"
data_dir   = "c:/nomad/data"

#  서버
server {
  enabled = true
  bootstrap_expect = 1
}

 # ACL 설정
 # acl을 생략할 경우 노마드에 누구나 접근할 수 있기 때문에 반드시 설정하기를 추천합니다.
 # 처음 replication_token 에는 본인이 토큰으로 쓸 48자의 랜덤hex값을 넣어야합니다.
 # 많은 예제에서 openssl 같은걸 쓰라고하는데 귀찮으니 브라우저 열고 콘솔에서 자바스크립트로 생성해 봅시다.
 # Array.from(crypto.getRandomValues(new Uint8Array(24)), b => b.toString(16).padStart(2, '0')).join('');
acl {
  enabled = true
  token_ttl = "30m"
  policy_ttl = "30m"
  replication_token = "위 자바스크립트로 생성한 48자의 랜덤hex값을 넣습니다."
}

# 클라이언트
client {
  enabled = true
  # 네트워크 인터페이스가 없으면 설정하지 않아도 됩니다.
  network_interface = "CORENET"
}

# 콘술은 나중에 설명할 예정인데 꼭 콘술을 쓰지 않아도 되지만 이왕이면 같은 하시코프에서 만든것을 넣도록 하겠습니다.
consul {
  address = "127.0.0.1:8500"
}

```
- 아래처럼 실행하자.
- 필자는 지정된 network-interface 를 사용하기 때문에 설정했지만 그렇지 않은경우는 없어도 된다.
```
nomad agent -config=c:/nomad/nomad.hcl
```
- 특정 네트워크 인터페이스를 지정하고 싶다면 아래와 같이 설정할 수 있다.
```
nomad agent -config=c:/nomad/nomad.hcl -network-interface=네트워크인터페이스이름
```
- http://localhost:4646/ 로 접속하면 노마드 웹UI가 나온다.
- 하지만 토큰을 인증하라고 나올것이다.

### 토큰생성
admin-policy.hcl 작성
```
# admin-policy.hcl
namespace "*" {
  policy = "write"
}

node {
  policy = "write"
}

agent {
  policy = "write"
}

operator {
  policy = "write"
}
```
- 정책적용 / 토큰생성
```
# bootstrap 토큰을 생성.
nomad acl bootstrap
# 출력된 Secret ID 를 환경변수로 설정하자
# windows cmd 는 set NOMAD_TOKEN=
# windows powershell 는 $env:NOMAD_TOKEN =
# linux export NOMAD_TOKEN=생성된SecretID
# 정책적용
nomad acl policy apply admin-policy admin-policy.hcl
# 결과출력
# Successfully wrote "admin-policy" ACL policy!
# 토큰생성
nomad acl token create -name="admin-token" -policy="admin-policy"
# 여기서 나온 결과를 저장해 놓자. 특히 시크릿은 중요하다.
```
- 이제 http://localhost:4646/ 로 접속하면 토큰"SecretID"을 입력해보자.



https://github.com/marketplace/actions/setup-hashicorp-nomad-pack
```
name: Anissia Core Nomad Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Nomad CLI
        run: |
          wget https://releases.hashicorp.com/nomad/1.1.6/nomad_1.1.6_linux_amd64.zip
          unzip nomad_1.1.6_linux_amd64.zip
          sudo mv nomad /usr/local/bin/

      - name: Deploy to Nomad
        env:
          NOMAD_ADDR: ${{ secrets.NOMAD_ADDR }}
          NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}
        run: |
          nomad job run path/to/anissia-core.nomad

```