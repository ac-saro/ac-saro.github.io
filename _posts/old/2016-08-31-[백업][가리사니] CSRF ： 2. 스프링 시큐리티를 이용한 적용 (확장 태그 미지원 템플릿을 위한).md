---
layout: post
tags: [security, http, spring]
---

> 이 문서는 가리사니 개발자 포럼에 올렸던 글의 백업 파일입니다.
오래된 문서가 많아 현재 상황과 맞지 않을 수 있습니다.


# CSRF 시리즈
- [1. 공격법과 방어법 (XSS 설명 추가)](/2016/08/31/%EB%B0%B1%EC%97%85-%EA%B0%80%EB%A6%AC%EC%82%AC%EB%8B%88-CSRF-1.-%EA%B3%B5%EA%B2%A9%EB%B2%95%EA%B3%BC-%EB%B0%A9%EC%96%B4%EB%B2%95-(XSS-%EC%84%A4%EB%AA%85-%EC%B6%94%EA%B0%80).html)
- [2. 스프링 시큐리티를 이용한 적용 (확장 태그 미지원 템플릿을 위한)](/2016/08/31/%EB%B0%B1%EC%97%85-%EA%B0%80%EB%A6%AC%EC%82%AC%EB%8B%88-CSRF-2.-%EC%8A%A4%ED%94%84%EB%A7%81-%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%A0%81%EC%9A%A9-(%ED%99%95%EC%9E%A5-%ED%83%9C%EA%B7%B8-%EB%AF%B8%EC%A7%80%EC%9B%90-%ED%85%9C%ED%94%8C%EB%A6%BF%EC%9D%84-%EC%9C%84%ED%95%9C).html)


# 스프링 시큐리티 설치
[스프링 시큐리티 시리즈](/2016/07/24/%EB%B0%B1%EC%97%85-%EA%B0%80%EB%A6%AC%EC%82%AC%EB%8B%88-Spring-boot-Security-1.-%EC%84%A4%EC%B9%98-%EB%B0%8F-%ED%8E%98%EC%9D%B4%EC%A7%80-%EC%84%A4%EC%A0%95.html)
스프링 시큐리티 설치시 기본으로 csrf 가 작동합니다.


# Mustache 예제
또 여러가지 지원을 해주지 않는 머스터치를 위해 인터셉터를 추가해보겠습니다.
``` html
<html>
<body>
	<form method="POST" enctype="multipart/form-data" action="/넘길페이지">
		<div>
			<input type="submit" value="Upload" />
		</div>
	</form>
</body>
</html>
```
보통 위와 같이 넘기게 될경우 403 (서비스 거부) 오류가 날 것입니다.
머스터치에선 바로 시큐리티를 빼올 수 없기 때문에 HandlerInterceptor 를 써보겠습니다.
``` html
<html>
<body>
	<form method="POST" enctype="multipart/form-data" action="/넘길페이지">
		<div>
			<input type="hidden" name="_csrf" value="{{#_csrf}}token{{/_csrf}}" />
			<input type="submit" value="Upload" />
		</div>
	</form>
</body>
</html>
```
_csrf.token 으로 값을 주었습니다.
[참고 HandlerInterceptorAdapter](/2016/08/19/%EB%B0%B1%EC%97%85-%EA%B0%80%EB%A6%AC%EC%82%AC%EB%8B%88-%EC%8A%A4%ED%94%84%EB%A7%81-WebMvcConfigurerAdapter-%EC%99%80-HandlerInterceptorAdapter.html)
``` java
@Component
public class CsrfInterceptor extends HandlerInterceptorAdapter
{
	@Override
	public void postHandle
	(
		HttpServletRequest req, HttpServletResponse res, Object handler, ModelAndView modelAndView
	) throws Exception
	{
		if (modelAndView != null)
		{
			// _csrf 를 찾아.
			modelAndView.addObject("_csrf", new Mustache.Lambda()
			{
				public void execute(Template.Fragment frag, Writer out) throws IOException
				{
					// token 에 해당할 경우
					if ("token".equals(frag.execute()))
					{
						// 토큰으로 치환
						out.write( ((CsrfToken) req.getAttribute(CsrfToken.class.getName())).getToken() );
					}
				}
			});
		}

		super.postHandle(req, res, handler, modelAndView);
	}
}
```
인터셉터 추가
``` java
@Configuration
public class WebMvcConfig extends WebMvcConfigurerAdapter
{
	@Autowired
	CsrfInterceptor csrfInterceptor;

	@Override
	public void addInterceptors(InterceptorRegistry registry)
	{
		registry.addInterceptor(csrfInterceptor);
	}
}
```


# 실행
소스보기를 누르면 아래와같이 추가되어있을겁니다.
물론 저 벨류는 랜덤한 값으로 보냅니다. (강의 1장 참고)
``` html
<html>
<body>
	<form method="POST" enctype="multipart/form-data" action="/넘길페이지">
		<div>
			<input type="hidden" name="_csrf" value="a60159ae-9b7f-45dc-9c97-3a5f14a39cbd" />
			<input type="submit" value="Upload" />
		</div>
	</form>
</body>
</html>
```
그리고 넘겼을 경우 403없이 정상 작동할 경우 성공!!